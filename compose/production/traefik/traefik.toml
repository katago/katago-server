# This is traefik's dynamic configuration ONLY
# The static configuration for traefik is specified via command line arguments
# through docker compose.

[tls.options]
  [tls.options.default]
    minVersion = "VersionTLS12"

[http.routers]
  [http.routers.media]
    rule = "Host(`{{env "TRAEFIK_ROUTER_DOMAIN_NAME"}}`) && PathPrefix(`/media`)"
    entryPoints = ["web"]
    middlewares = ["redirect"]
    service = "nginx"
  [http.routers.media-secure]
    rule = "Host(`{{env "TRAEFIK_ROUTER_DOMAIN_NAME"}}`) && PathPrefix(`/media`)"
    entryPoints = ["web-secure"]
    service = "nginx"
    [http.routers.media-secure.tls]
      certResolver = "letsencrypt"
  [http.routers.web]
    rule = "Host(`{{env "TRAEFIK_ROUTER_DOMAIN_NAME"}}`)"
    entryPoints = ["web"]
    middlewares = ["redirect", "csrf"]
    service = "django"
  [http.routers.web-secure]
    rule = "Host(`{{env "TRAEFIK_ROUTER_DOMAIN_NAME"}}`)"
    entryPoints = ["web-secure"]
    middlewares = ["csrf"]
    service = "django"
    [http.routers.web-secure.tls]
      certResolver = "letsencrypt"
  [http.routers.flower]
    rule = "Host(`{{env "TRAEFIK_ROUTER_DOMAIN_NAME"}}`)"
    entryPoints = ["flower"]
    service = "flower"
    [http.routers.flower.tls]
      certResolver = "letsencrypt"

[http.middlewares]
  [http.middlewares.redirect.redirectScheme]
    scheme = "https"
    permanent = true
  [http.middlewares.csrf.headers]
    hostsProxyHeaders = ["X-CSRFToken"]

[http.services]
  [http.services.django.loadBalancer]
    [[http.services.django.loadBalancer.servers]]
      url = "http://django:5000"
  [http.services.nginx.loadBalancer]
    [[http.services.nginx.loadBalancer.servers]]
      url = "http://nginx:80"
  [http.services.flower.loadBalancer]
    [[http.services.flower.loadBalancer.servers]]
      url = "http://flower:5555"
